<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><title>Manager | Emerald</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-black mb-8 text-slate-800">ðŸ’¼ Manager Desk</h1>
  <div id="managerList" class="max-w-2xl mx-auto space-y-4"></div>

<script>
async function loadManagerData() {
  const res = await fetch("/manager-data");
  const data = await res.json();
  const container = document.getElementById("managerList");
  container.innerHTML = "";

  data.orders.filter(o => o.status !== "Completed").forEach(order => {
    const div = document.createElement("details");
    div.className = "bg-white p-4 rounded-xl shadow cursor-pointer";
    div.innerHTML = `
      <summary class="flex justify-between items-center font-bold">
        <span>${order.name} <span class="text-xs text-gray-400">#${order.orderId}</span></span>
        <span class="text-yellow-600">â‚¹${order.totalAmount}</span>
      </summary>
      <div class="mt-4 p-4 border-t border-gray-100 bg-gray-50 rounded-lg">
        <ul class="mb-4">${order.items.map(i => `<li class="text-sm flex justify-between"><span>${i.qty}x ${i.name}</span> <span>â‚¹${i.price * i.qty}</span></li>`).join("")}</ul>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
          <input id="rupee-${order.orderId}" type="number" placeholder="Discount (â‚¹)" oninput="calc('${order.orderId}', ${order.totalAmount})" class="p-2 border rounded">
          <input id="pct-${order.orderId}" type="number" placeholder="Discount (%)" oninput="calc('${order.orderId}', ${order.totalAmount})" class="p-2 border rounded">
        </div>

        <div class="text-xs space-y-1 border-t pt-2">
          <div class="flex justify-between"><span>CGST (2.5%)</span> <span id="cgst-${order.orderId}">â‚¹0</span></div>
          <div class="flex justify-between"><span>SGST (2.5%)</span> <span id="sgst-${order.orderId}">â‚¹0</span></div>
          <div class="flex justify-between font-bold text-lg"><span>Total</span> <span id="total-${order.orderId}">â‚¹${order.totalAmount}</span></div>
        </div>
        
        <button onclick="finalize('${order.orderId}')" class="w-full bg-black text-white py-3 mt-4 rounded-xl font-bold uppercase">Print Bill & Complete</button>
      </div>`;
    container.appendChild(div);
  });
}

function calc(id, base) {
  const r = parseFloat(document.getElementById(`rupee-${id}`).value) || 0;
  const p = parseFloat(document.getElementById(`pct-${id}`).value) || 0;
  const afterDisc = base - (r + (base * (p/100)));
  const gst = afterDisc * 0.025;
  document.getElementById(`cgst-${id}`).innerText = "â‚¹" + gst.toFixed(2);
  document.getElementById(`sgst-${id}`).innerText = "â‚¹" + gst.toFixed(2);
  document.getElementById(`total-${id}`).innerText = "â‚¹" + (afterDisc + (gst * 2)).toFixed(2);
}

async function finalize(id) {
  const final = document.getElementById(`total-${id}`).innerText.replace("â‚¹", "");
  await fetch("/finalize-bill", { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({orderId: id, finalTotal: final}) });
  window.print();
  loadManagerData();
}
setInterval(loadManagerData, 5000); loadManagerData();
</script>
</body>
</html>