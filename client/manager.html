<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Emerald Manager | Table & Billing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            #printReceipt, #printReceipt * { visibility: visible; }
            #printReceipt { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .table-occupied { background: #ef4444; color: white; } /* Red */
        .table-free { background: #22c55e; color: white; } /* Green */
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">

    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-10 bg-white p-6 rounded-2xl shadow-sm">
            <h1 class="text-3xl font-black text-gray-800 tracking-tighter">EMERALD <span class="text-yellow-500">MANAGER</span></h1>
            <div id="liveClock" class="text-lg font-mono font-bold text-gray-500"></div>
        </div>

        <h2 class="text-xl font-bold mb-4 text-gray-700">Live Table Status</h2>
        <div id="tableGrid" class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-10">
            </div>

        <div class="bg-white rounded-2xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-6 border-b pb-4 text-gray-800">Pending Payments</h2>
            <div id="managerOrders" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="printReceipt" class="hidden text-black p-6 bg-white w-[80mm] font-serif leading-tight">
        <center>
            <h1 class="text-2xl font-bold uppercase">Emerald</h1>
            <p class="text-xs">Premium Fine Dining</p>
            <p class="text-xs mb-2">Phone: +91 99999 00000</p>
            <div class="border-t border-b border-black py-1 my-2 text-[10px] flex justify-between">
                <span id="p-orderId"></span>
                <span id="p-date"></span>
            </div>
        </center>
        <table class="w-full text-xs mb-2">
            <thead><tr class="border-b border-black text-left"><th>Item</th><th>Qty</th><th class="text-right">Price</th></tr></thead>
            <tbody id="p-items"></tbody>
        </table>
        <div class="border-t border-black pt-2 text-[11px] space-y-1">
            <div class="flex justify-between"><span>Subtotal:</span><span id="p-sub"></span></div>
            <div class="flex justify-between text-red-600"><span>Discount:</span><span id="p-disc"></span></div>
            <div class="flex justify-between"><span>CGST (2.5%):</span><span id="p-cgst"></span></div>
            <div class="flex justify-between"><span>SGST (2.5%):</span><span id="p-sgst"></span></div>
            <div class="flex justify-between font-bold text-lg border-t border-black pt-1">
                <span>Total:</span><span id="p-grand"></span>
            </div>
        </div>
        <center class="mt-4 border-t border-dashed border-black pt-4">
            <p class="text-[10px] italic">Payment Mode: <span id="p-mode"></span></p>
            <p class="text-xs font-bold mt-1">Thank You! Visit Again</p>
        </center>
    </div>

<script>
    // Configuration
    const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbzDNZPsdmgkG_Lloqg2Wh0TflSqTuZBPO5b2F-XowRqXgvxUmXEf8F7TowGxK4Gtsob/exec";
    let activeOrders = [];

    // 1. Clock
    setInterval(() => { document.getElementById('liveClock').innerText = new Date().toLocaleTimeString(); }, 1000);

    // 2. Fetch Data
    async function refreshManagerData() {
        const res = await fetch('/kitchen-data'); // Local Node.js server
        activeOrders = await res.json();
        renderTables();
        renderOrders();
    }

    // 3. Render Tables
    function renderTables() {
        const grid = document.getElementById("tableGrid");
        grid.innerHTML = "";
        for(let i=1; i<=10; i++) {
            const orderAtTable = activeOrders.find(o => o.tableNum == i);
            const card = document.createElement("div");
            card.className = `p-4 rounded-xl text-center font-bold shadow-sm ${orderAtTable ? 'table-occupied' : 'table-free'}`;
            
            // Calculate time occupied
            let timeMsg = "Free";
            if(orderAtTable) {
                const mins = Math.floor((new Date() - new Date(orderAtTable.timestamp)) / 60000);
                timeMsg = `${mins} mins`;
            }

            card.innerHTML = `<div>Table ${i}</div><div class="text-xs font-normal">${timeMsg}</div>`;
            grid.appendChild(card);
        }
    }

    // 4. Render Orders for Checkout
    function renderOrders() {
        const list = document.getElementById("managerOrders");
        list.innerHTML = "";
        activeOrders.forEach(order => {
            const row = document.createElement("div");
            row.className = "flex justify-between items-center p-4 bg-gray-50 rounded-xl border border-gray-200";
            row.innerHTML = `
                <div>
                    <span class="font-bold text-gray-800">${order.name} (T-${order.tableNum})</span>
                    <p class="text-xs text-gray-500">${order.items.map(i => i.name + ' x'+ i.qty).join(', ')}</p>
                </div>
                <button onclick="processCheckout('${order._id}')" class="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold text-sm">Generate Bill</button>
            `;
            list.appendChild(row);
        });
    }

    // 5. Billing Logic
    async function processCheckout(id) {
        const order = activeOrders.find(o => o._id === id);
        const discInput = prompt("Enter Discount (e.g. 100 or 10%):", "0");
        const mode = prompt("Payment Mode (Cash, UPI, Card, Cheque):", "Cash");
        
        let subtotal = order.totalAmount;
        let discountAmt = 0;

        if(discInput.includes('%')) {
            discountAmt = (subtotal * parseFloat(discInput)) / 100;
        } else {
            discountAmt = parseFloat(discInput);
        }

        let taxable = subtotal - discountAmt;
        let cgst = taxable * 0.025; // Change if needed
        let sgst = taxable * 0.025;
        let grand = taxable + cgst + sgst;

        // Populate Receipt
        document.getElementById("p-orderId").innerText = "ID: " + order.orderId;
        document.getElementById("p-date").innerText = new Date().toLocaleString();
        document.getElementById("p-sub").innerText = "₹" + subtotal;
        document.getElementById("p-disc").innerText = "-₹" + discountAmt.toFixed(2);
        document.getElementById("p-cgst").innerText = "₹" + cgst.toFixed(2);
        document.getElementById("p-sgst").innerText = "₹" + sgst.toFixed(2);
        document.getElementById("p-grand").innerText = "₹" + Math.round(grand);
        document.getElementById("p-mode").innerText = mode;

        let itemsHtml = "";
        order.items.forEach(i => {
            itemsHtml += `<tr><td>${i.name}</td><td>${i.qty}</td><td class="text-right">₹${i.price * i.qty}</td></tr>`;
        });
        document.getElementById("p-items").innerHTML = itemsHtml;

        // TRIGGER PRINT
        window.print();

        // Update Permanent Record (Google Sheets)
        const finalPayload = { ...order, discount: discountAmt, totalTax: cgst+sgst, finalBill: grand, paymentMode: mode, status: "Paid" };
        
        fetch(GOOGLE_SHEET_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(finalPayload) });
        
        // Finalize locally
        await fetch('/update-order-status', { 
            method: "POST", 
            headers: {"Content-Type": "application/json"}, 
            body: JSON.stringify({ id: id, status: "Completed" }) 
        });
        
        refreshManagerData();
    }

    setInterval(refreshManagerData, 5000);
    refreshManagerData();
</script>
</body>
</html>