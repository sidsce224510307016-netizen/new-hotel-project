<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Emerald | Billing</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body { font-family: 'Inter', sans-serif; background:#000; color: white; }
  .locked { opacity: 0.5; pointer-events: none; }
  #timerProgress { transition: width 1s linear; }
  .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 1rem; }
</style>
</head>
<body>

<header class="min-h-screen flex items-center justify-center p-4">
  <div class="bg-white/10 backdrop-blur-lg p-8 rounded-2xl w-full max-w-md border border-white/20">
    <h1 class="text-3xl font-bold mb-6 text-center text-yellow-500">Emerald Billing</h1>
    
    <div class="space-y-4">
      <input id="custName" placeholder="Customer Name" class="w-full p-3 rounded-lg text-black outline-none focus:ring-2 focus:ring-yellow-500">
      
      <select id="paymentMethod" class="w-full p-3 rounded-lg text-black outline-none">
        <option value="Cash">Payment: Cash</option>
        <option value="Card">Payment: Card</option>
        <option value="UPI">Payment: UPI</option>
        <option value="Cheque">Payment: Cheque</option>
      </select>

      <div class="flex gap-2">
        <input id="discountInput" type="number" placeholder="Discount (₹)" oninput="renderMenu()" class="w-1/2 p-3 rounded-lg text-black outline-none">
        <input id="taxInput" type="number" value="5" placeholder="Tax (%)" oninput="renderMenu()" class="w-1/2 p-3 rounded-lg text-black outline-none">
      </div>
      
      <button onclick="confirmDetails()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 rounded-xl transition-all">Start Order</button>
    </div>
  </div>
</header>

<section id="menuSection" class="min-h-screen bg-stone-100 text-black p-4 pb-64 locked">
  <h2 class="text-3xl font-bold mb-8 text-center">Our Menu</h2>
  <div id="menuGrid" class="menu-grid max-w-4xl mx-auto"></div>

  <div class="fixed bottom-0 left-0 w-full bg-white border-t border-gray-300 shadow-2xl z-50">
    <div id="timerContainer" class="h-1 bg-gray-200 w-full hidden">
        <div id="timerProgress" class="h-full bg-green-600 w-full"></div>
    </div>
    
    <div class="p-4 max-w-4xl mx-auto">
        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
            <p class="text-gray-500">Subtotal: <span id="subtotal" class="font-bold text-black">₹0</span></p>
            <p class="text-gray-500 text-right">Tax: <span id="taxDisplay" class="font-bold text-black">₹0</span></p>
            <p class="text-gray-500">Discount: <span id="discDisplay" class="font-bold text-red-600">-₹0</span></p>
            <p class="text-xl font-bold text-yellow-600 text-right">Total: <span id="totalBill">₹0</span></p>
        </div>
        
        <div class="flex gap-3">
          <button id="editBtn" onclick="cancelGracePeriod()" class="hidden w-1/3 bg-gray-200 hover:bg-gray-300 font-bold py-4 rounded-xl text-xs uppercase transition-all">Edit Items</button>
          <button id="mainOrderBtn" onclick="initiateOrder()" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-4 rounded-xl text-lg uppercase shadow-lg transition-all">Send to Kitchen</button>
        </div>
    </div>
  </div>
</section>

<script>
// REPLACE WITH YOUR ACTUAL DEPLOYED GOOGLE SCRIPT URL
const GOOGLE_SHEET_URL = "https://script.google.com/macros/s/AKfycbw8ubb_Qc2tJqUpv4FSTna1KMFjhXwFuGvviNijRmdsTBwyM_dNkJhrzTRgH1_90PJ_VA/exec";

let cart = [];
let orderTimer = null;
let secondsLeft = 180;

const menu = {
  "Items": [
    {id:1, name:"Paneer Tikka", price:220, image:"https://images.unsplash.com/photo-1567188040759-fb8a883dc6d8"},
    {id:2, name:"Paneer Bhurji", price:260, image:"https://images.unsplash.com/photo-1603894584214-434079873d9e"},
    {id:3, name:"Roti", price:25, image:"https://images.unsplash.com/photo-1589187151003-0dd473a094e6"},
    {id:4, name:"Butter Naan", price:40, image:"https://images.unsplash.com/photo-1601050638917-3d844766314d"}
  ]
};

function confirmDetails() {
  if(!document.getElementById("custName").value) return alert("Please enter customer name");
  document.getElementById("menuSection").classList.remove("locked");
  document.getElementById("menuSection").scrollIntoView({behavior:"smooth"});
  renderMenu();
}

function renderMenu() {
  const grid = document.getElementById("menuGrid");
  grid.innerHTML = "";
  let subtotal = 0;

  menu.Items.forEach(item => {
    const cartItem = cart.find(i => i.name === item.name);
    const qty = cartItem ? cartItem.qty : 0;
    subtotal += (qty * item.price);

    grid.innerHTML += `
      <div class="bg-white rounded-xl shadow-md overflow-hidden border border-gray-200">
        <img src="${item.image}" class="h-32 w-full object-cover">
        <div class="p-3">
          <p class="font-bold text-sm">${item.name}</p>
          <p class="text-yellow-600 font-bold">₹${item.price}</p>
          <div class="flex items-center mt-2 gap-2">
            <button onclick="changeQty('${item.name}', -1)" class="bg-gray-200 px-2 rounded">-</button>
            <span class="text-sm font-bold">${qty}</span>
            <button onclick="changeQty('${item.name}', 1)" class="bg-yellow-500 px-2 rounded text-white">+</button>
          </div>
        </div>
      </div>`;
  });

  const disc = Number(document.getElementById("discountInput").value) || 0;
  const taxRate = Number(document.getElementById("taxInput").value) || 0;
  const taxAmt = (subtotal - disc) * (taxRate / 100);
  const total = (subtotal - disc) + taxAmt;

  document.getElementById("subtotal").innerText = "₹" + subtotal;
  document.getElementById("taxDisplay").innerText = "₹" + taxAmt.toFixed(2);
  document.getElementById("discDisplay").innerText = "-₹" + disc;
  document.getElementById("totalBill").innerText = "₹" + total.toFixed(2);
}

function changeQty(name, delta) {
  const idx = cart.findIndex(i => i.name === name);
  if(idx > -1) {
    cart[idx].qty += delta;
    if(cart[idx].qty <= 0) cart.splice(idx, 1);
  } else if(delta > 0) {
    cart.push({name, price: menu.Items.find(i=>i.name===name).price, qty: 1});
  }
  renderMenu();
}

function initiateOrder() {
  if(cart.length === 0) return alert("Add items to cart first");
  
  const mainBtn = document.getElementById("mainOrderBtn");
  const editBtn = document.getElementById("editBtn");
  const timerContainer = document.getElementById("timerContainer");

  document.getElementById("menuGrid").classList.add("locked");
  editBtn.classList.remove("hidden");
  timerContainer.classList.remove("hidden");
  
  mainBtn.classList.replace("bg-yellow-500", "bg-green-600");
  mainBtn.onclick = finalizeOrder; // Make it tapable to send instantly
  
  secondsLeft = 180;
  orderTimer = setInterval(() => {
    secondsLeft--;
    const mins = Math.floor(secondsLeft / 60);
    const secs = secondsLeft % 60;
    mainBtn.innerText = `SEND NOW (${mins}:${secs < 10 ? '0' : ''}${secs})`;
    document.getElementById("timerProgress").style.width = (secondsLeft / 180) * 100 + "%";
    
    if(secondsLeft <= 0) {
      clearInterval(orderTimer);
      finalizeOrder();
    }
  }, 1000);
}

function cancelGracePeriod() {
  clearInterval(orderTimer);
  document.getElementById("menuGrid").classList.remove("locked");
  document.getElementById("editBtn").classList.add("hidden");
  document.getElementById("timerContainer").classList.add("hidden");
  
  const mainBtn = document.getElementById("mainOrderBtn");
  mainBtn.innerText = "Send to Kitchen";
  mainBtn.classList.replace("bg-green-600", "bg-yellow-500");
  mainBtn.onclick = initiateOrder;
}

function finalizeOrder() {
  const payload = {
    orderId: "EM-" + Date.now(),
    name: document.getElementById("custName").value,
    items: cart,
    paymentMethod: document.getElementById("paymentMethod").value,
    discount: document.getElementById("discountInput").value || 0,
    tax: document.getElementById("taxDisplay").innerText.replace("₹", ""),
    totalAmount: document.getElementById("totalBill").innerText.replace("₹", "")
  };

  fetch(GOOGLE_SHEET_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  }).then(() => {
    alert("Order successfully sent to kitchen!");
    location.reload();
  }).catch(() => alert("Error sending order."));
}
</script>
</body>
</html>